localPlayer.AnimationMode = Enum.AnimationMode.Rifle
local muzzle = localPlayer.Avatar.Bone_R_Hand.G_Gun_AK_02_Instance.G_Gun_AK_02.Muzzle
local interval = 0.1
local timer = 0
local decalColor = Color(255,255,255,255)

--获取射击目标的位置与方向信息
function GetFireResult()
	local ray = world.CurrentCamera:ViewportPointToRay(Vector3(0.5, 0.5, 0))
	local hitPosition = ray:GetPoint(20)
	local hitObject = nil
	local hitNormal = Vector3.Zero
	dir = (hitPosition - muzzle.Position).Normalized
	local hitResults = Physics:RaycastAll(ray.Origin, ray.Origin + ray.Direction * 20, false)
	for i,v in pairs(hitResults.HitObjectAll) do
		if v.Block then
			dir = (hitResults.HitPointAll[i] - muzzle.Position).Normalized
			hitPosition = hitResults.HitPointAll[i]
			hitObject = v
			hitNormal = hitResults.HitNormalAll[i]
			break
		end
	end
	return dir, hitPosition, hitObject, hitNormal
end

--射线检测的直接射击模式
function FireInstant()
	local dir, hitPosition, hitObject, hitNormal = GetFireResult()
	localPlayer:Attack()
	world:CreateInstance('Blast', 'Blast', muzzle, muzzle.Position)
	world:CreateInstance('Blast', 'Blast', world.Temp1, hitPosition)
	world:CreateInstance('Fire', 'Fire', world.Temp1, muzzle.Position):Play()
--	local decal = world:CreateInstance('Decal', 'Decal', hitObject, hitPosition)
--	local index = string.format("%02d",math.random(1, 16))
--	decal.DecalImage = ResourceManager.GetTexture('Decal/DecalBump_'..index)
--	decal.Size = Vector3(2,2,2)
--	decal.Position = Vector3(hitPosition.x, hitPosition.y, hitPosition.z)
--	decal.DecalColor = decalColor
--	decal.Up = hitNormal
	timer = interval
end

--射出实体子弹的射击模式
function FireProjectile()
	local dir, hitPosition = GetFireResult()
	localPlayer:Attack()
	local bullet = world:CreateInstance('Bullet', 'Bullet', world.Temp2, muzzle.Position)
	world:CreateInstance('Blast', 'Blast', muzzle, muzzle.Position)
	world:CreateInstance('Fire', 'Fire', world.Temp1, muzzle.Position):Play()
	bullet.LinearVelocity = dir * 20
	bullet.OnCollisionBegin:Connect(function(_, hitpoint)
		world:CreateInstance('Hit', 'Hit', world.Temp1, hitpoint)
	end)
end

--左键射线射击模式，右键子弹射击模式
Input.OnKeyDown:Connect(function()
	if Input.GetPressKeyData(Enum.KeyCode.Mouse0) == 1 then
		if timer <= 0 then
			FireInstant()
		end
	elseif Input.GetPressKeyData(Enum.KeyCode.Mouse1) == 1 then
		FireProjectile()
	end
end)

--按住左键持续射击
Input.OnKeyHold:Connect(function()
	if Input.GetPressKeyData(Enum.KeyCode.Mouse0) == 2 then
		if timer <= 0 then
			FireInstant()
		end
	end
end)

Input.OnKeyDown:Connect(function()
	if Input.GetPressKeyData(Enum.KeyCode.F) == 1 then
		decalColor = Color(math.random(0,255), math.random(0,255), math.random(0,255), 255)
	end
end)

localPlayer.Local.ControlGUI.JumpButton.OnDown:Connect(function()
	if timer <= 0 then
		FireInstant()
	end	
end)
world.OnRenderStepped:Connect(function(delta)
	localPlayer:Aim(world.CurrentCamera.Rotation.x * -1)
	timer = timer - delta
	if timer <= 0 then
		canFire = true
	end
end)
