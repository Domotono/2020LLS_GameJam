wait()
local Bow = require(BowModule)
Bow:Init(localPlayer,localPlayer.Avatar.Bone_L_Hand.Bow)
local ChargeTime = 0
local UI = localPlayer.Local.ScreenGUI.Circle
local Target = Vector3.Zero
world.OnRenderStepped:Connect(function(delta)
	if Bow.Aiming then
		--每帧获取射线检测的击中点
		local Ray= world.CurrentCamera:ViewportPointToRay(Vector3(0.5,0.5,0))
		local Origin = Ray.Origin
		local EndPoint = Ray:GetPoint(100)
		local HitInfo = Physics:RaycastAll(Origin, EndPoint, false)
		local HitObjects = HitInfo.HitObjectAll
		Target = EndPoint
		for i,v in pairs(HitObjects) do
			if v.Block then
				Target = HitInfo.HitPointAll[i]
				break
			end
		end
		--调整动作状态机的Pitch值
		Bow:Aim(world.CurrentCamera.Rotation.x*-1,Target)
		--根据蓄力时间调整弓弦的位置
		Bow.Center.LocalPosition = Vector3(0,0,ChargeTime*0.4)
		Bow.Center.Line1.LocalPosition = Vector3(0,0.25,-ChargeTime*0.2)
		Bow.Center.Line2.LocalPosition = Vector3(0,-0.25,-ChargeTime*0.2)
		Bow.Center.Line1.Size = Vector3(0.02,0.5/math.cos(math.atan(ChargeTime*0.2/0.25)),0.02)
		Bow.Center.Line2.Size = Bow.Center.Line1.Size
		Bow.Center.Line1.LocalRotation = EulerDegree(math.deg(-math.atan(ChargeTime*0.2/0.25)),0,0)
		Bow.Center.Line2.LocalRotation = EulerDegree(math.deg(math.atan(ChargeTime*0.2/0.25)),0,0)
		ChargeTime = math.min(ChargeTime + delta,0.5)
		UI.Size = Vector2(30,30)*(1.2-ChargeTime*2)
	else
		Bow:StopAim()
	end
end)

--按下鼠标左键开始瞄准
Input.OnKeyDown:Connect(function()
	if Input.GetPressKeyData(Enum.KeyCode.Mouse0) == Enum.KeyState.KeyStatePress and Bow.CanFire then
		Bow.Aiming = true
		Bow:Charge(math.floor(world.CurrentCamera.Rotation.x * -1))
	end
end)

--松开鼠标左键射出箭
Input.OnKeyUp:Connect(function()
	if Input.GetPressKeyData(Enum.KeyCode.Mouse0) == Enum.KeyState.KeyStateRelease and Bow.Aiming then
		Bow.Aiming = false
		Bow:Attack(ChargeTime,Target)
		ChargeTime = 0 
		UI.Size = Vector2(30,30)
		Bow.Center.LocalPosition = Vector3(0,0,0)
		Bow.Center.Line1.LocalPosition = Vector3(0,0.25,0)
		Bow.Center.Line2.LocalPosition = Vector3(0,-0.25,0)
		Bow.Center.Line1.Size = Vector3(0.02,0.5,0.02)
		Bow.Center.Line2.Size = Vector3(0.02,0.5,0.02)
		Bow.Center.Line1.LocalRotation = EulerDegree(0,0,0)
		Bow.Center.Line2.LocalRotation = EulerDegree(0,0,0)
		wait(1)
		Bow:Reload()
	end
end)